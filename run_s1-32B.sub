#!/bin/bash
#SBATCH --job-name=s1_s1-32B
#SBATCH --partition=a100
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=4
#SBATCH --gpus=1
#SBATCH --mem=120G
#SBATCH --time=04:00:00
#SBATCH --output=logs/s1-32B.log
#SBATCH --error=logs/s1-32B.log

set -euo pipefail

echo "📌 SLURM job started on: $(hostname)"
echo "📅 Date: $(date)"

MODEL_ID="s1-32B"
MODEL_HF="simplescaling/s1-32B"
TASKS="aime24_nofigures,openai_math,gpqa_diamond_openai"

DEF_PATH=/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/s1/apptainer.def
SIF_PATH=/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/s1/s1.sif
RESULTS_LOCAL="results/${MODEL_ID}"
RESULTS_IN_CONTAINER="/workspace/results/${MODEL_ID}"

# === 自动构建容器镜像 ===
if [ -f "$SIF_PATH" ]; then
  echo "✅ 已存在容器镜像 $SIF_PATH，跳过构建。"
else
  echo "🚧 开始构建 $SIF_PATH ..."
  apptainer build --fakeroot "$SIF_PATH" "$DEF_PATH" || {
    echo "❌ 容器构建失败"
    exit 1
  }
fi

# === 宿主机结果目录准备 ===
mkdir -p "$RESULTS_LOCAL"

# === 容器内运行推理任务 ===
for k in 512 1024 2048 4096 8192; do
  SUBDIR="s1_${k}"
  echo "🚀 Running inference with max_tokens_thinking=$k"

  apptainer exec --nv --bind results:/workspace/results "$SIF_PATH" bash -c "
    set -euo pipefail
    mkdir -p /workspace/results/${SUBDIR}/${MODEL_ID}
    cd /opt/app/s1
    lm_eval \
      --model vllm \
      --model_args pretrained=${MODEL_HF},dtype=float16,tensor_parallel_size=1 \
      --tasks ${TASKS} \
      --output_path /workspace/results/${SUBDIR}/${MODEL_ID} \
      --log_samples \
      --apply_chat_template \
      --gen_kwargs \"max_gen_toks=32768,max_tokens_thinking=${k}\"
  "
done

echo "✅ 所有推理任务完成，结果已保存到宿主机目录：$RESULTS_LOCAL/"