#!/bin/bash
#SBATCH --job-name=s1_s1-32B
#SBATCH --partition=a100
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=8
#SBATCH --gpus=1
#SBATCH --time=06:00:00
#SBATCH --output=logs/s1-32B_output.log
#SBATCH --error=logs/s1-32B_error.log

mkdir -p results

set -euo pipefail
trap 'echo "❌ 脚本失败: 行号 $LINENO, 状态码 $?"' ERR

echo "📌 SLURM job started on: $(hostname)"
echo "📅 Date: $(date)"

MODEL_ID="s1-32B"
MODEL_HF="simplescaling/s1-32B"
TASK_LIST=("aime24_nofigures" "openai_math" "gpqa_diamond_openai")

DEF_PATH=/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/s1/apptainer.def
SIF_PATH=/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/s1/s1.sif
RESULTS_LOCAL="results/${MODEL_ID}"
RESULTS_IN_CONTAINER="/workspace/results/${MODEL_ID}"

HF_TOKEN=$(<.hf_token)
if [ -z "$HF_TOKEN" ]; then
  echo "❌ .hf_token 文件为空或不存在，请创建该文件并填入 Hugging Face token"
  exit 1
fi

# === 构建容器镜像（如必要）===
if [ -f "$SIF_PATH" ]; then
  echo "✅ 容器镜像已存在: $SIF_PATH，跳过构建。"
else
  echo "🚧 开始构建 $SIF_PATH ..."
  apptainer build --fakeroot "$SIF_PATH" "$DEF_PATH" || {
    echo "❌ 容器构建失败"
    exit 1
  }
fi

# === 每个 task + 每个 max_tokens_thinking 独立推理并保存 ===
for k in 512 1024 2048 4096 8192; do
  for task in "${TASK_LIST[@]}"; do
    SUBDIR="s1_${k}/${task}"
    echo "🚀 推理任务：task=${task}, max_tokens_thinking=${k}"

    apptainer exec --nv \
      --env HF_TOKEN=$HF_TOKEN \
      --bind results:/workspace/results \
      "$SIF_PATH" bash -c "
        set -euo pipefail
        huggingface-cli login --token \$HF_TOKEN

        mkdir -p /workspace/results/${SUBDIR}/${MODEL_ID}
        cd /opt/app/s1
        lm_eval \
          --model vllm \
          --model_args pretrained=${MODEL_HF},dtype=float16,tensor_parallel_size=1 \
          --tasks ${task} \
          --output_path /workspace/results/${SUBDIR}/${MODEL_ID} \
          --log_samples \
          --apply_chat_template \
          --gen_kwargs \"max_gen_toks=32768,max_tokens_thinking=${k}\"
      "

    echo "📦 已完成 task=${task}, k=${k}，结果保存在 results/${SUBDIR}/${MODEL_ID}/"
  done
done

echo "✅ 所有推理任务完成，结果已分步保存到：$RESULTS_LOCAL/"
