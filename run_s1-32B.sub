#!/bin/bash
#SBATCH --job-name=s1_s1-32B
#SBATCH --partition=a100
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=8
#SBATCH --gpus=1
#SBATCH --time=06:00:00
#SBATCH --output=logs/s1-32B_output.log
#SBATCH --error=logs/s1-32B_error.log

mkdir -p results

set -euo pipefail
trap 'echo "âŒ è„šæœ¬å¤±è´¥: è¡Œå· $LINENO, çŠ¶æ€ç  $?"' ERR

echo "ğŸ“Œ SLURM job started on: $(hostname)"
echo "ğŸ“… Date: $(date)"

MODEL_ID="s1-32B"
MODEL_HF="simplescaling/s1-32B"
TASK_LIST=("aime24_nofigures" "openai_math" "gpqa_diamond_openai")

DEF_PATH=/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/s1/apptainer.def
SIF_PATH=/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/s1/s1.sif
RESULTS_LOCAL="results/${MODEL_ID}"
RESULTS_IN_CONTAINER="/workspace/results/${MODEL_ID}"

HF_TOKEN=$(<.hf_token)
if [ -z "$HF_TOKEN" ]; then
  echo "âŒ .hf_token æ–‡ä»¶ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œè¯·åˆ›å»ºè¯¥æ–‡ä»¶å¹¶å¡«å…¥ Hugging Face token"
  exit 1
fi

# === æ„å»ºå®¹å™¨é•œåƒï¼ˆå¦‚å¿…è¦ï¼‰===
if [ -f "$SIF_PATH" ]; then
  echo "âœ… å®¹å™¨é•œåƒå·²å­˜åœ¨: $SIF_PATHï¼Œè·³è¿‡æ„å»ºã€‚"
else
  echo "ğŸš§ å¼€å§‹æ„å»º $SIF_PATH ..."
  apptainer build --fakeroot "$SIF_PATH" "$DEF_PATH" || {
    echo "âŒ å®¹å™¨æ„å»ºå¤±è´¥"
    exit 1
  }
fi

# === æ¯ä¸ª task + æ¯ä¸ª max_tokens_thinking ç‹¬ç«‹æ¨ç†å¹¶ä¿å­˜ ===
for k in 512 1024 2048 4096 8192; do
  for task in "${TASK_LIST[@]}"; do
    SUBDIR="s1_${k}/${task}"
    echo "ğŸš€ æ¨ç†ä»»åŠ¡ï¼štask=${task}, max_tokens_thinking=${k}"

    apptainer exec --nv \
      --env HF_TOKEN=$HF_TOKEN \
      --bind results:/workspace/results \
      "$SIF_PATH" bash -c "
        set -euo pipefail
        huggingface-cli login --token \$HF_TOKEN

        mkdir -p /workspace/results/${SUBDIR}/${MODEL_ID}
        cd /opt/app/s1
        lm_eval \
          --model vllm \
          --model_args pretrained=${MODEL_HF},dtype=float16,tensor_parallel_size=1 \
          --tasks ${task} \
          --output_path /workspace/results/${SUBDIR}/${MODEL_ID} \
          --log_samples \
          --apply_chat_template \
          --gen_kwargs \"max_gen_toks=32768,max_tokens_thinking=${k}\"
      "

    echo "ğŸ“¦ å·²å®Œæˆ task=${task}, k=${k}ï¼Œç»“æœä¿å­˜åœ¨ results/${SUBDIR}/${MODEL_ID}/"
  done
done

echo "âœ… æ‰€æœ‰æ¨ç†ä»»åŠ¡å®Œæˆï¼Œç»“æœå·²åˆ†æ­¥ä¿å­˜åˆ°ï¼š$RESULTS_LOCAL/"
