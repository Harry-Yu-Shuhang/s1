#!/bin/bash
#SBATCH --job-name=s1_Qwen2.5-32B-Instruct-AWQ
#SBATCH --partition=a100
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=4
#SBATCH --gpus=1
#SBATCH --mem=120G
#SBATCH --time=04:00:00
#SBATCH --output=logs/s1_output_Qwen2.5-32B-Instruct-AWQ.log
#SBATCH --error=logs/s1_error_Qwen2.5-32B-Instruct-AWQ.log

set -euo pipefail

echo "ğŸ“Œ SLURM job started on: $(hostname)"
echo "ğŸ“… Date: $(date)"

MODEL_ID="Qwen2.5-32B-Instruct-AWQ"
MODEL_HF="Qwen/Qwen2.5-32B-Instruct-AWQ"

DEF_PATH=/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/s1/apptainer.def
SIF_PATH=/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/s1/s1.sif
RESULTS_LOCAL="results/${MODEL_ID}"
RESULTS_IN_CONTAINER="/workspace/results/${MODEL_ID}"

# === è‡ªåŠ¨æ„å»ºå®¹å™¨é•œåƒ ===
if [ -f "$SIF_PATH" ]; then
  echo "âœ… å·²å­˜åœ¨å®¹å™¨é•œåƒ $SIF_PATHï¼Œè·³è¿‡æ„å»ºã€‚"
else
  echo "ğŸš§ å¼€å§‹æ„å»º $SIF_PATH ..."
  apptainer build --fakeroot "$SIF_PATH" "$DEF_PATH" || {
    echo "âŒ å®¹å™¨æ„å»ºå¤±è´¥"
    exit 1
  }
fi

# === å®¿ä¸»æœºç»“æœç›®å½•å‡†å¤‡ ===
mkdir -p "$RESULTS_LOCAL"

# === å®¹å™¨å†…è¿è¡Œæ¨ç†ä»»åŠ¡ ===
for k in 512 1024 2048 4096 8192; do
  echo "ğŸš€ Running inference with max_tokens_thinking=$k"
  apptainer exec --nv --bind results:/workspace/results "$SIF_PATH" bash -c "
    set -euo pipefail
    mkdir -p /workspace/results/${MODEL_ID}
    cd /opt/app/s1
    lm_eval \
      --model vllm \
      --model_args pretrained=${MODEL_HF},dtype=float16,tensor_parallel_size=1 \
      --tasks aime24_nofigures \
      --output_path /workspace/results/s1_${k} \
      --log_samples \
      --apply_chat_template \
      --gen_kwargs \"max_gen_toks=32768,max_tokens_thinking=${k}\"
  "
done

echo "âœ… æ‰€æœ‰æ¨ç†ä»»åŠ¡å®Œæˆï¼Œç»“æœå·²ä¿å­˜åˆ°å®¿ä¸»æœºç›®å½•ï¼š$RESULTS_LOCAL/"
