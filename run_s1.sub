#!/bin/bash
#SBATCH --job-name=s1_scaling
#SBATCH --partition=a100
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=4
#SBATCH --gpus=1
#SBATCH --mem=120G
#SBATCH --time=04:00:00
#SBATCH --output=logs/s1_output.log
#SBATCH --error=logs/s1_error.log

set -euo pipefail

echo "ğŸ“Œ SLURM job started on: $(hostname)"
echo "ğŸ“… Date: $(date)"

DEF_PATH=/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/s1/apptainer.def
SIF_PATH=/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/s1/s1.sif

# === è‡ªåŠ¨æ„å»ºå®¹å™¨é•œåƒ ===
if [ -f "$SIF_PATH" ]; then
  echo "âœ… å·²å­˜åœ¨å®¹å™¨é•œåƒ $SIF_PATHï¼Œè·³è¿‡æ„å»ºã€‚"
else
  echo "ğŸš§ å¼€å§‹æ„å»º $SIF_PATH ..."
  apptainer build --fakeroot "$SIF_PATH" "$DEF_PATH" || {
    echo "âŒ å®¹å™¨æ„å»ºå¤±è´¥"
    exit 1
  }
fi

# === å®¹å™¨å†…è¿è¡Œæ¨ç†ä»»åŠ¡ ===
apptainer exec --nv "$SIF_PATH" bash -c '
  set -euo pipefail
  cd /opt/app/s1  # âœ… åˆ‡æ¢åˆ°å¯å†™æŒ‚è½½è·¯å¾„
  mkdir -p results

  for k in 512 1024 2048 4096 8192; do
    echo "ğŸš€ Running inference with max_tokens_thinking=$k"
    if ! lm_eval \
      --model vllm \
      --model_args pretrained=Qwen/Qwen2.5-7B-Instruct-AWQ,dtype=float16,tensor_parallel_size=1 \
      --tasks aime24_nofigures \
      --output_path ./results/s1_${k} \
      --log_samples \
      --apply_chat_template \
      --gen_kwargs "max_gen_toks=32768,max_tokens_thinking=${k}"; then
        echo "âŒ æ¨ç†å¤±è´¥ï¼šmax_tokens_thinking=${k}"
        exit 1
    fi
  done
' | tee -a logs/s1_output.log

# === åˆ¤æ–­å®¹å™¨ä»»åŠ¡æ˜¯å¦æˆåŠŸ ===
if [ $? -ne 0 ]; then
  echo "âŒ Apptainer å†…ä»»åŠ¡å¤±è´¥ï¼Œé€€å‡º SLURM ä»»åŠ¡"
  exit 1
else
  echo "âœ… æ‰€æœ‰æ¨ç†ä»»åŠ¡å®Œæˆ"
fi
